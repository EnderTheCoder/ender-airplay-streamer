cmake_minimum_required(VERSION 3.27)
include_directories(playfair llhttp)

aux_source_directory(. play_src)
set(DIR_SRCS ${play_src})

add_library(airplay
        STATIC
        ${DIR_SRCS}
)

target_link_libraries(airplay
        playfair
        llhttp)

if (WIN32)

    target_compile_definitions(airplay PRIVATE WIN32_LEAN_AND_MEAN _WINSOCK_DEPRECATED_NO_WARNINGS)

    find_package(unofficial-libplist CONFIG REQUIRED)
    target_link_libraries(airplay
            unofficial::libplist::libplist
    )
    find_package(PThreads4W REQUIRED)

    # ğŸ”§ æ·»åŠ  Bonjour SDK æ”¯æŒ
    # æ–¹æ³•1: æŸ¥æ‰¾å·²å®‰è£…çš„ Bonjour SDK
    find_path(BONJOUR_INCLUDE_DIR dns_sd.h
            PATHS
            "C:/Program Files/Bonjour SDK/Include"
            "C:/Program Files (x86)/Bonjour SDK/Include"
            ENV INCLUDE
    )

    find_library(BONJOUR_LIBRARY
            NAMES dnssd
            PATHS
            "C:/Program Files/Bonjour SDK/Lib/x64"
            "C:/Program Files (x86)/Bonjour SDK/Lib/x64"
            ENV LIB
    )

    if (BONJOUR_INCLUDE_DIR AND BONJOUR_LIBRARY)
        target_include_directories(airplay PRIVATE ${BONJOUR_INCLUDE_DIR})
        target_link_libraries(airplay ${BONJOUR_LIBRARY})
        message(STATUS "Found Bonjour SDK: ${BONJOUR_INCLUDE_DIR}")
    else ()
        # æ–¹æ³•2: å¦‚æœæ²¡æœ‰å®‰è£… SDKï¼Œä½¿ç”¨åŠ¨æ€åŠ è½½æ–¹å¼
        # ä½ çš„ä»£ç å·²ç»æ”¯æŒåŠ¨æ€åŠ è½½ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç»§ç»­ç¼–è¯‘
        message(WARNING "Bonjour SDK not found, will use dynamic loading")
        # æ·»åŠ å¿…è¦çš„ Windows API
        target_link_libraries(airplay ws2_32 iphlpapi)
    endif ()

elseif (UNIX)
    find_library(LIBPLIST NAMES plist plist-2.0)
    target_link_libraries(airplay ${LIBPLIST} pthread)
endif ()

find_package(OpenSSL 1.1.1 REQUIRED)
target_compile_definitions(airplay PUBLIC OPENSSL_API_COMPAT=0x10101000L)
target_link_libraries(airplay OpenSSL::Crypto)

if (UNIX AND NOT APPLE)
    target_link_libraries(airplay dns_sd)
endif ()

if (WIN32)
    target_link_libraries(airplay ws2_32 iphlpapi PThreads4W::PThreads4W)
endif ()
